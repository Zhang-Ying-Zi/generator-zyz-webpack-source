<template>
  <div class="page">
    <div class="call-content page-content">
      <div id="myhome" class="width-100">
        <!-- 本地视频 -->
        <div id="local_my" class="video-grid"></div>

        <!-- 连接中 -->
        <div id="video_live" class="video-grid" style="display: none;">
          <div id="remote_stream" class="video-placeholder"></div>
          <div id="local_stream" class="video-placeholder"></div>
          <div class="display-inline-flex call-icons">
            <div class="hangup"><div class="guaduan"><img class="pointer" src="img/btn_hangup.png" width="72" height="72" /></div><div>挂断</div></div>
            <div class="answer"><div class="jieting"><img class="pointer" src="img/btn_answer.png" width="72" height="72" /></div><div>接听</div></div>
          </div>
        </div>

        <!-- 设备信息 -->
        <div id="video_info" class="video-grid" style="display: none;">
          <div style="padding: 0 30px">
            <p class="text-align-center text-color-white margin" style="font-size: 30px;">视频来源相关设备信息</p>
            <div class="line"></div>
            <div class="row" id="info_row"></div>
            <!-- 接通后可编辑内容 -->
            <div id="edit_info" style="display: none;">
              <div class="line"></div>
              <div class="row">
                <div class="col-25">问题描述：</div><div class="col-75">
                  <textarea class="width-100" rows="4" name="description"></textarea>
                </div>
                <div class="col-25 margin-top">问题分类：</div><div class="col-75 margin-top">
                  <button data-type="TX" class="ques button button-outline color-white">通信问题</button>
                  <button data-type="EQ" class="ques button button-outline color-white">设备故障</button>
                  <button data-type="EV" class="ques button button-outline color-white">环境原因</button>
                  <button data-type="OT" class="ques button button-outline color-white">其他原因</button>
                </div>
                <div class="col-25 margin-top">当前结果：</div><div class="col-75 margin-top radios">
                  <input class="mt-10" type="radio" name="result" id="result1" value="1">
                  <label class="pointer" style="margin-right: 20px" for="result1">已结单</label>
                  <input class="mt-10" type="radio" name="result" id="result2" value="2">
                  <label class="pointer" style="margin-right: 20px" for="result2">运维处理</label>
                </div>
              </div>
              <div class="line margin-bottom"></div>
              <div class="width-100 text-align-center">
                <button class="button fs16 saveinfo" @click="save()">保存</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<script>

  return {
    methods: {
      save: function() {
        var self = this;
        var app = self.$app;
        var myinfo = {
          remark: $$('#edit_info [name="description"]').val(),
          curesult: $$('#edit_info [name="result"]:checked').val(),
          troubleType: ''
        }
        var selectedType = $$('.ques.selected');
        selectedType.forEach(function(curele) {
          myinfo.troubleType = curele.dataset.type;
          // myinfo.troubleType.push(curele.dataset.type);
        });
        if (!myinfo.troubleType) {
          return app.dialog.alert('请选择问题分类');
        }
        if (!myinfo.curesult) {
          return app.dialog.alert('请选择当前处理结果');
        }
        console.log(myinfo);
        app.dialog.confirm('确定提交保存?', '提示', function() {
          var rparm = Object.assign({}, myinfo, {
            openid: Template7.global.receiveCall.openid,
            type: Template7.global.receiveCall.type,
            id: Template7.global.receiveCall.id,
            recordid: Template7.global.receiveCall.recordid || 0
          });
          apiService('/webrtc/saveRecord', rparm, function () {
            app.dialog.alert('提交成功');
            window.savetimeout && clearTimeout(window.savetimeout); // 关闭1分钟保存时间
            closeVedioRequest(); // 保存后关闭信息填写框
          });
        });
      },
      createMyStream: async function () {
        window.localStream && window.localStream.close();
        window.localStream = TRTC.createStream({
          audio: true, // 采集麦克风
          video: true, // 采集摄像头
          userId: 'xingcall_local_' + new Date().getTime()
        });
        // 设置视频分辨率帧率和码率
        window.localStream.setVideoProfile('720p');
        window.localStream.setAudioProfile('high');

        await window.localStream.initialize();
      },
      joinLocalRoom: async function() {
        var self = this;
        try {
          // 采集摄像头和麦克风视频流
          await self.createMyStream({ audio: true, video: true });
          // ('摄像头及麦克风采集成功！');
        } catch (error) {
          app.dialog.alert('请确认已连接摄像头和麦克风并授予其访问权限！');
          console.log(error);
        }
        window.localStream && window.localStream.play('local_my');
        self.isPlaying = true;
      },
    },
    on: {
      pageBeforeOut: function() {
        // 关闭本地流，释放摄像头和麦克风访问权限
        window.localStream && window.localStream.close();
        window.localStream = null;
      },
      pageInit: function() {
        var self = this;
        window.localStream && window.localStream.close();  
        // <span class="call-time">05:29</span>

        $$('#local_my').on('click', function() {
          if (!self.isPlaying || !window.localStream) {
            self.joinLocalRoom();
          }
        });

        $$('#local_my').click();
        
        function getHigt() {
          return ($$('#local_my').height() / 4 * 3).toFixed(0) + 'px';
        }
        $$('.video-grid').css({ width: getHigt() });

        window.onresize = function () {
          $$('.video-grid').css({ width: getHigt() });
        }
        // 通话中不允许切换页面或者退出
        // $$('.home-navbar').css('pointer-events', 'none');
      }
    }
  }
</script>