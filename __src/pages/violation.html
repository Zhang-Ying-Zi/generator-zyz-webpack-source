<template>
  <div class="page illegol-park-page" style="background: #f5f5f5;">
    <div class="page-content padding-base">

      <div class="base-container">
        <div class="current-menu">
          <div class="title">当前位置：</div>
          <div class="info">违停记录</div>
        </div>

        <div class="inline-labels list search-container">
          <form class="search-form">
            <ul>
              <li class="item-content item-input">
                <div class="item-media">停车场</div>
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input type="text" name="parkingname" class="input-item" />
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-media">车牌号</div>
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input type="text" name="plate" class="input-item" />
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-media">上传人</div>
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input type="text" name="createuser" class="input-item" />
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-media">上传时间</div>
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input type="text" placeholder="开始时间" name="begintime" class="select-item date-item" />
                  </div>
                </div>
              </li>
              <li class="item-content item-input" style="padding-left: 5px !important;">
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <div class="time-adon"></div>
                  </div>
                </div>
              </li>
              <li class="item-content item-input" style="padding-left: 5px !important;">
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input type="text" placeholder="结束时间" name="endtime" class="select-item date-item" />
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-input-wrap btn">
                    <a class="button button-search" @click="search">筛选</a>
                  </div>
                </div>
              </li>
              <li class="stotal-num">
                <label>共<span class="totalnum">{{total}}</span>条</label></li>
            </ul>
          </form>
        </div>
        <div class="table-container">
          <div class="data-table data-table-init">
            <table>
              <thead>
                <tr class="text-align-center">
                  <th class="label-cell xuhao">序号</th>
                  <th class="label-cell">停车场</th>
                  <th class="label-cell">车牌号</th>
                  <th class="label-cell">现场图像</th>
                  <th class="label-cell">上传人</th>
                  <th class="label-cell">上传时间</th>
                  <th class="label-cell">违停说明</th>
                  <th class="label-cell">操作</th>
                </tr>
              </thead>
              <tbody class="table-trs bg-color-white">
                {{#each list}}
                <tr class="text-align-center">
                  <td class="label-cell xuhao">{{@index+1}}</td>
                  <td class="label-cell">{{cname}}</td>
                  <td class="label-cell">{{plate}}</td>
                  <td class="label-cell"><span class="state-blue pointer" @click="showBigImg('{{photoid}}', '{{photoname}}')">{{photoname}}</span></td>
                  <td class="label-cell">{{username}}</td>
                  <td class="label-cell">{{dateformat ctime 'yyyy-MM-dd hh:mm:ss' ''}}</td>
                  <td class="label-cell" style="word-break: break-all;max-width: 500px;">{{sdesc}}</td>
                  <td class="label-cell">
                    {{#js_if "this.submitstatus == 'N'"}}
                      <a class="state-blue" href="#" @click="edit({{id}})">编辑</a>
                      &nbsp;&nbsp;<span style="color: #eee; transform: scale(1, 1.2);">|</span>&nbsp;&nbsp;
                      <a class="state-blue" href="#" @click="upReport({{id}})">上报</a>
                    {{/js_if}}
                    {{#js_if "this.submitstatus == 'Y'"}}
                      <span class="state-grey">已上报</span>
                    {{/js_if}}
                  </td>
                </tr>
                {{else}}
                <tr class="nodata">
                  <td colspan="20">没有数据</td>
                </tr>
                {{/each}}
              </tbody>
            </table>
          </div>

          <div class="page-container pages">
            <div class="page-r">
              <ul id="page_ul" class="page-ul"></ul>
              <div class="float-left total-num">&nbsp;共<span>{{js "Math.ceil(this.total/this.queryParam.pagesize)"}}</span>页&nbsp;转至&nbsp;
              </div>
              <div class="float-left"><input name="jumppageno" /></div>
              <div class="float-left" style="line-height: 30px">&nbsp;页&nbsp;<button @click="jump()"
                  class="page-ok-btn pointer">确定</button></div>
            </div>
          </div>
        </div>

      </div>

      <!-- 编辑 -->
      <div class="dialog dialog-buttons-2 edit-dialog" id="edit-log">
        <div class="dialog-inner">
          <div class="dialog-title"><strong>编辑</strong>
            <div class="float-right">
              <a class="link dialog-close close-btn"></a>
            </div>
          </div>
          <div class="row" style="width: calc(100% - 40px);padding: 0px 20px;">
            <div class="col-25">停车场：</div><div class="col-75">{{current.cname}}</div>
            <div class="col-25">车牌号：</div><div class="col-75">
              <input type="text" name="editPlate" value="{{current.plate}}" placeholder="请输入"/></div>
            <div class="col-25">现场图像：</div><div class="col-75">{{current.photoname}}</div>
            <div class="col-25">上传人：</div><div class="col-75">{{current.username}}</div>
            <div class="col-25">上传时间：</div><div class="col-75">{{dateformat current.ctime 'yyyy-MM-dd hh:mm:ss' ''}}</div>
            <div class="col-25">违停说明：</div><div class="col-75">
              <textarea rows="4" name="editSdesc" value="{{current.sdesc}}"></textarea>
            </div>
          </div>
        </div>
        <div class="dialog-buttons">
          <span class="dialog-button dialog-close">取消</span>
          <span class="dialog-button dialog-button-bold update-weit" @click="save">确定</span>
        </div>
      </div>

      <!-- 现场影像 -->
      <div class="popup img-popup">
        <div class="page">
          <div class="navbar" style="height: 36px !important;background:linear-gradient(0deg,rgba(40,80,200,1),rgba(80,120,230,1)) !important;">
            <div class="navbar-inner sliding">
              <div class="title" style="font-size: 14px;font-weight: bold;">现场图像：<span id="imgname"></span></div>
              <div class="right"><a class="link popup-close close-btn"></a></div>
            </div>
          </div>
          <div class="page-content" style="padding-top: 36px !important;">
            <div class="content-block img-content text-align-center" style="overflow: auto;max-width: 100%;padding-top: 20px;">
              <div id="div-move"><img id="bigImg" style="overflow-y: auto;width: auto;max-width: 800px;max-height: 600px;" draggable="false"/></div>
              <input type="text" name="focusIpt" style="opacity: 0;position: absolute;top:48px;left:0">
              <div style="position: fixed;bottom:20px;left:0;width: 100%;user-select: none;">
                <div class="scale-ops">
                  <span class="icon-big">
                    <svg class="icon" width="24" height="24" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M750.3 198.7C598 46.4 351.1 46.4 198.7 198.7s-152.3 399.2 0 551.5C345.1 896.6 578.8 902.3 732 767.3l172.1 172.1 35.4-35.4-172.1-171.9c135-153.2 129.3-387-17.1-533.4z m39.3 403.8c-17.1 42.1-42.2 80-74.7 112.4-32.5 32.5-70.3 57.6-112.4 74.7-40.7 16.5-83.8 24.9-128 24.9s-87.2-8.4-128-24.9c-42.1-17.1-80-42.2-112.4-74.7s-57.6-70.3-74.7-112.4c-16.5-40.7-24.9-83.8-24.9-128s8.4-87.2 24.9-128c17.1-42.1 42.2-80 74.7-112.4s70.3-57.6 112.4-74.7c40.7-16.5 83.8-24.9 128-24.9s87.2 8.4 128 24.9c42.1 17.1 80 42.2 112.4 74.7 32.5 32.5 57.6 70.3 74.7 112.4 16.5 40.7 24.9 83.8 24.9 128s-8.4 87.3-24.9 128zM671 502H496v175h-50V502H271v-50h175V277h50v175h175v50z" fill=""></path></svg>  
                  </span>
                  <span class="icon-small">
                    <svg width="24" height="24" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6655"><path d="M768 448a320 320 0 1 0-320 320 320 320 0 0 0 320-320z m64 0A384 384 0 1 1 448 64a384 384 0 0 1 384 384z" p-id="6656"></path><path d="M681.28 726.72a32 32 0 0 1 45.44-45.44l160 160a32 32 0 0 1-45.44 45.44zM288 480a32 32 0 0 1 0-64h320a32 32 0 0 1 0 64z" p-id="6657"></path></svg>
                  </span>
                  <span class="icon-trans"><svg class="icon" width="22" height="22" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M961.45 362.18V137.45l-96.93 96.93C781.45 128.89 652.62 61.16 507.58 62.57 271.24 64.85 72.15 257.78 62.9 493.94 52.86 750.39 257.78 961.45 512 961.45c166.26 0 311.09-90.52 388.83-224.73h-43.78C775.39 861.87 627.8 940.06 463.37 921.2c-187.7-21.52-339.93-174.33-360.76-362.11C75.05 310.47 268.94 100 512 100c132.91 0 250.39 63.49 325.7 161.21L736.73 362.18h224.72z" fill="black"></path></svg>
                  </span>
                  <span class="icon-trans-inverse"><svg class="icon" width="22" height="22" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M62.55 362.18V137.45l96.93 96.93c83.08-105.5 211.91-173.22 356.95-171.82 236.33 2.29 435.43 195.21 444.68 431.38C971.14 750.39 766.22 961.45 512 961.45c-166.26 0-311.09-90.52-388.83-224.73h43.78C248.61 861.87 396.2 940.06 560.63 921.2c187.7-21.52 339.93-174.33 360.76-362.11C948.95 310.47 755.06 100 512 100c-132.91 0-250.39 63.49-325.7 161.21l100.97 100.97H62.55z" fill="black"></path></svg>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<style>
  .img-popup {
    width: 30%;
    min-width: 280px;
    max-width: 98%;
    min-height: 200px;
    max-height: 98%;
    margin: auto;
    position: absolute;
    left: 0 !important;
    top: 0 !important;
    z-index: 999999;
  }
  .img-popup ::-webkit-scrollbar {
    width: 6px;
  }
  .img-popup ::-webkit-scrollbar-thumb {
    width: 6px;
    background: #cccccc;
    border-radius: 5px;
  }
  .scale-ops {
    margin:auto;
    height: 26px;
    border-radius: 12px;
    background: #fff;
    display:inline-block;
    white-space: nowrap;
  }
  .scale-ops span {
    margin-right: 5px;
    display: inline-block;
  }
  .scale-ops svg {
    height: 26px;
    cursor: pointer;
  }
</style>
<script>

  return {
    data: function () {
      return {
        queryParam: {
          curpage: 1,
          pagesize: PAGE_SIZE,
          createuser: '',
          plate: '',
          begintime: '',
          endtime: '',
          parkingname: ''
        },
        current: {},
        list: [],
        total: 0,
        pageConfig: Object.assign({}, PAGE_DEFAULT_CONFIG, { noInitCallback: true }),
      }
    },
    methods: {
      search: function () {
        var self = this;
        var app = self.$app;
        var fdata = app.form.convertToData('.search-form');
        var copyparam = Object.assign({}, self.queryParam);
        Object.keys(fdata).forEach(function (key) {
          copyparam[key] = fdata[key] == '全部' ? '' : fdata[key];
        });
        if (copyparam.begintime) {
          copyparam.begintime = new Date(copyparam.begintime).format('yyyy-MM-dd 00:00:00');
        }
        if (copyparam.endtime) {
          copyparam.endtime = new Date(copyparam.endtime).format('yyyy-MM-dd 23:59:59');
        }
        self.queryParam = Object.assign({}, copyparam);
        self.queryParam.curpage = 1;
        $$('input[name="jumppageno"]').val('');
        self.getList();
      },
      jump: function () {
        var self = this;
        var pagenums = Math.ceil(self.total / self.queryParam.pagesize) || 1;
        var curnum = ($$('input[name="jumppageno"]').val() || 0) - 0;
        if (curnum == self.queryParam.curpage || curnum <= 0 || curnum > pagenums) {
          return;
        }
        self.pageIng.initPage(self.total, pagenums, curnum);
        self.queryParam.curpage = curnum;
        self.getList(true);
      },
      getList: function (isPageNoClick) {
        var self = this;
        apiService('/dispatch/' + localStorage.curgrpid + '/alarm/listViolationHis', self.queryParam, function (data) { // 请求成功
          var total = data.count || 0;
          self.$setState({ list: data.list || [], total: total });

          if (isPageNoClick) return; // 点击页码，无需初始化分页

          self.pageConfig.totalCount = total || 0;
          self.pageIng = new Paging(self.pageConfig, function (pageIndex, pageSize) {
            self.queryParam.curpage = +pageIndex;
            self.getList(true);
          });
        });
      },
      showBigImg: function (pid, iname) { // 显示大图
        var self = this;
        self.$app.preloader.show();

        blobApiService('/dispatch/' + localStorage.curgrpid + '/alarm/getViolationPhoto', {photoid: pid}).then(function(data) {
          var blob = new Blob([data], { type: "image/png" });
          self.blobUrl = URL.createObjectURL(blob);
          $$('#bigImg').attr('src', self.blobUrl);
          $$('#imgname').text(iname);
          self.$app.popup.open('.img-popup');

          self.scale = 1;
          self.angle = 0;
          $$('#div-move').transform('scale(1)'); // 清空上一次旋转及移动属性
          $$('#div-move').css('transform-origin', '');
          $$('#bigImg').transform('rotate(0deg)');
          $$('#bigImg').css('transform-origin','');

          $$('#bigImg').on('load', function() {
            self.$app.preloader.hide();

            var width = $$('#bigImg').width() + 40;
            var height = $$('#bigImg').height() + 76;
            var mt = window.innerHeight > height ? (window.innerHeight - height) / 2 : 0;
            $$('.img-popup').css({
              marginLeft: 'calc(50% - ' + (width*0.95 / 2).toFixed(0) + 'px)',
              marginTop: mt.toFixed(0) + 'px',
              width: (width > 840 ? 840 : width) + 'px',
              height: (height > 676 ? 676 : height) + 'px'
            });
          }, function() {
            self.$app.preloader.hide();
          });
          
          // 移动鼠标焦点到弹框内，否则无法直接滚动内容
          setTimeout(function() { $$('input[name="focusIpt"]').focus(); }, 500);
        }).catch(function(errtext) {
          self.$app.preloader.hide();
          self.$app.dialog.alert(errtext);
        });
      },
      upReport: function (vid) { // 上报
        var self = this;
        self.$app.dialog.confirm('确定上报该条违停记录？', function() {
          apiService('/dispatch/' + localStorage.curgrpid + '/alarm/submitViolation', {violationId: vid}, function (data) {
            self.$app.dialog.alert('上报成功');
            self.getList();
          });
        }, function(){});
      },
      save: function () {
        var self = this;
        if (!self.current.id) {
          return;
        }
        var newplate = $$('input[name="editPlate"]').val();
        var newsdesc = $$('textarea[name="editSdesc"]').val();
        // if (!newplate) {
        //   self.dialog.close();
        //   return self.$app.dialog.alert('请输入车牌号', function() {
        //     self.dialog.open();
        //   });
        // }
        if (newsdesc && (newsdesc.indexOf('<') !== -1 || newsdesc.indexOf('>')!== -1)) {
          self.dialog.close();
          return self.$app.dialog.alert('不可输入字符<或者>', function() {
            self.dialog.open();
          });
        }
        if (newsdesc && newsdesc.length > 50) {
          self.dialog.close();
          return self.$app.dialog.alert('违停说明长度不能超过50', function() {
            self.dialog.open();
          });
        }
        if (newplate && newplate.trim().length !== 7 && newplate.trim().length !== 8) {
          self.dialog.close();
          return self.$app.dialog.alert('请输入格式正确的车牌号', function() {
            self.dialog.open();
          });
        }
        apiService('/dispatch/' + localStorage.curgrpid + '/alarm/editViolation', {
          violationId: self.current.id, 
          plate: newplate.trim(),
          sdesc: newsdesc
        }, function (data) {
          self.dialog.close();
          self.$app.dialog.alert('保存成功', function() {
            self.getList();
          });
        });
      },
      edit: function (cid) { // 编辑
        var self = this;
        if (!cid) {
          return;
        }
        self.editId = cid;
        var curinfo = Object.assign({}, self.list.find(function(cc) {return cc.id == cid;}));
        self.$setState({current: curinfo});
        $$('input[name="editPlate"]').val(self.current.plate);
        $$('textarea[name="editSdesc"]').val(self.current.sdesc);

        self.dialog = self.$app.dialog.create({
          el: '#edit-log',
          on: {
            opened: function () {
              $$('.dialog-close').on('click', function() {
                self.dialog.close();
              });
            }
          }
        });
        self.dialog.open();
      }
    },
    on: {
      pageInit: function () {
        initDate();

        var self = this;
        self.getList();

        self.scale = 1;
        self.angle = 0;

        $$('.icon-big').on('click', function(){scaleChange(1.1);});
        $$('.icon-small').on('click', function(){scaleChange(0.9);});
        $$('.icon-trans').on('click', function(){ // 顺时针
          self.isMove = false;

          self.angle = (self.angle + 90)%360;
          $$('#bigImg').transform('rotate('+ self.angle +'deg)');
          $$('#bigImg').css('transform-origin', ($$('#bigImg').width()/2).toFixed(2)+'px '+($$('#bigImg').height()/2).toFixed(2)+'px');
        });
        $$('.icon-trans-inverse').on('click', function(){
          self.isMove = false;

          self.angle = (self.angle - 90)%360;
          $$('#bigImg').transform('rotate('+ self.angle +'deg)');
          $$('#bigImg').css('transform-origin', ($$('#bigImg').width()/2).toFixed(2)+'px '+($$('#bigImg').height()/2).toFixed(2)+'px');
        });

        moveEvent();

        function scaleChange(scaleNum) {
          self.isMove = false;
          self.scale = self.scale * scaleNum;
          $$('#div-move').transform('scale('+ self.scale +')');
          $$('#div-move').css('transform-origin', $$('#div-move').css('transform-origin'));
        }

        function moveEvent() {
          $$('#bigImg').css('cursor', 'pointer');
          var elemt = document.getElementById('bigImg');

          elemt.addEventListener('mousedown', function(e){
            self.isMove = true;
            e = e || window.event;
            self.sx = e.x;
            self.sy = e.y;
            var xy = $$('#div-move').css('transform-origin').split(' ');
            self.ox = xy[0].replace('px', '').replace('%', '') - 0;
            self.oy = xy[1].replace('px', '').replace('%', '') - 0;
          });
          elemt.addEventListener('mouseup', function(){
            self.isMove = false;
          });
          elemt.addEventListener('mousemove', function(e){
            if (self.isMove) {
              e = e || window.event;
              var reverse = self.scale > 1;
              var oleft = ((e.x - self.sx) * (reverse ?-1:1)).toFixed(0) - 0 + self.ox;
              var otop = ((e.y - self.sy) * (reverse ?-1:1)).toFixed(0) - 0 + self.oy;
              $$('#div-move').css('transform-origin', oleft +'px ' + otop + 'px');
            }
          });
        }
      }
    }
  }
</script>